# BeanOutputConverter와 PromptTemplate 사용 가이드

## 개요
Spring AI에서 `BeanOutputConverter`와 `PromptTemplate`을 사용하여 AI 응답을 구조화된 Java 객체로 변환하는 방법

---

## 1단계: BeanOutputConverter 생성

```java
BeanOutputConverter<List<Hotel>> converter = 
    new BeanOutputConverter<>(new ParameterizedTypeReference<List<Hotel>>() {});
```

### 설명
- **JSON ↔ Java 객체 변환기**
- `ParameterizedTypeReference<List<Hotel>>()`: 제네릭 타입 정보 `List<Hotel>`을 런타임에 보존하기 위한 트릭

### Converter의 역할
1. **`getFormat()`**: AI가 따라야 할 JSON 스키마 생성
2. **`convert(json)`**: JSON 문자열을 `List<Hotel>` 객체로 변환

---

## 2단계: PromptTemplate 생성

```java
PromptTemplate promptTemplate = PromptTemplate.builder() 
    .template("""
        다음 도시 들에서 유명한 호텔 3개를 형식에 맞게 출력하시오.
        도시: {cities}
        출력 형식: {format}
    """)
    .build();
```

### 설명
- 템플릿을 만든다 (아직 실제 값은 안 들어감)
- `{cities}`와 `{format}`은 **플레이스홀더(빈칸)**
- 나중에 실제 값으로 채워질 예정

---

## 3단계: PromptTemplate 렌더링 (변수 채우기)

```java
promptTemplate.render(Map.of("cities", cities, "format", converter.getFormat()))
```

### 설명
- `cities` 파라미터 값 (예: "서울, 부산")이 `{cities}`에 들어간다
- `converter.getFormat()`이 반환하는 **JSON 스키마**가 `{format}`에 들어간다

### 렌더링 결과 예시
```
다음 도시 들에서 유명한 호텔 3개를 형식에 맞게 출력하시오.
도시: 서울, 부산
출력 형식: {
  "type": "array",
  "items": {
    "type": "object",
    "properties": {
      "name": {"type": "string"},
      "address": {"type": "string"},
      "rating": {"type": "number"}
    }
  }
}
```

---

## 4단계: ChatClient로 AI 호출

```java
String json = chatClient.prompt()
    .user(promptTemplate.render(...))  // 완성된 프롬프트 전달
    .call()                             // AI 호출
    .content();                         // 응답 텍스트 추출
```

### 설명
- 완성된 프롬프트를 AI에게 보낸다
- AI는 요청받은 형식(JSON 스키마)에 맞춰 응답한다
- `json` 변수에는 **순수 JSON 문자열**이 저장된다

### JSON 응답 예시
```json
[
  {"name": "롯데호텔", "address": "서울시 중구", "rating": 5},
  {"name": "신라호텔", "address": "서울시 중구", "rating": 5},
  {"name": "파라다이스호텔", "address": "부산시 해운대", "rating": 4}
]
```

---

## 5단계: JSON을 Java 객체로 변환

```java
List<Hotel> listHotel = converter.convert(json);
```

### 설명
- `converter.convert()`가 JSON 문자열을 파싱한다
- Jackson 등의 라이브러리를 사용해 `List<Hotel>` 객체로 변환한다
- 이제 `listHotel`은 실제 Java 객체 리스트!

### 사용 예시
```java
listHotel.get(0).getName();   // "롯데호텔"
listHotel.get(1).getRating(); // 5
```

---

## 전체 흐름 요약

```
1. Converter 생성
   ↓ (getFormat() 호출 가능)
   
2. Template 생성 
   ↓
   
3. Template.render() 
   → "도시: 서울\n출력 형식: {JSON 스키마}"
   ↓
   
4. ChatClient.call()
   → AI가 JSON 문자열 반환
   → "[{hotel1}, {hotel2}, {hotel3}]"
   ↓
   
5. Converter.convert(json)
   → List<Hotel> 객체 생성
   ↓
   
6. return listHotel
```

---

## 핵심 포인트

| 메서드 | 역할 |
|--------|------|
| `converter.getFormat()` | AI에게 "이렇게 답변해줘!"라고 알려주는 형식 정의 |
| `promptTemplate.render()` | 템플릿의 빈칸(`{cities}`, `{format}`)을 실제 값으로 채움 |
| `chatClient.call().content()` | AI가 반환한 **텍스트 (JSON 형태)** |
| `converter.convert(json)` | JSON 텍스트를 **실제 Java 객체**로 변환 |

---

## 전체 코드

```java
@Service
@Slf4j
public class AiServiceParameterizedTypeReference {
  private ChatClient chatClient;

  public AiServiceParameterizedTypeReference(ChatClient.Builder chatClientBuilder) {
    chatClient = chatClientBuilder.build();
  }

  public List<Hotel> genericBeanOutputConverterLowLevel(String cities) {
    // 1. Converter 생성
    BeanOutputConverter<List<Hotel>> converter = 
        new BeanOutputConverter<>(new ParameterizedTypeReference<List<Hotel>>() {});
    
    // 2. Template 생성
    PromptTemplate promptTemplate = PromptTemplate.builder() 
        .template("""
            다음 도시 들에서 유명한 호텔 3개를 형식에 맞게 출력하시오.
            도시: {cities}
            출력 형식: {format}
        """)
        .build();

    // 3-4. Template 렌더링 및 AI 호출
    String json = chatClient.prompt()
        .user(promptTemplate.render(Map.of("cities", cities, "format", converter.getFormat())))
        .call()
        .content();

    // 5. JSON을 Java 객체로 변환
    List<Hotel> listHotel = converter.convert(json);
    
    return listHotel;
  }
}
```